<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculus 2 AAC Board Editor</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&display=swap');

  :root {
    --bg: #f0f2f5;
    --card: #ffffff;
    --border: #e0e0e0;
    --text: #1a1a1a;
    --text-dim: #666;
    --accent: #2563eb;
    --accent-hover: #1d4ed8;
    --danger: #dc2626;
    --danger-hover: #b91c1c;
    --success: #16a34a;
    --shadow: 0 1px 3px rgba(0,0,0,0.1);
    --shadow-lg: 0 4px 12px rgba(0,0,0,0.12);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* TOP BAR */
  .topbar {
    background: #1e293b;
    color: white;
    padding: 16px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }

  .topbar h1 {
    font-size: 1.2rem;
    font-weight: 700;
    letter-spacing: 0.02em;
  }

  .topbar-actions {
    display: flex;
    gap: 10px;
  }

  .btn {
    padding: 8px 18px;
    border: none;
    border-radius: 6px;
    font-family: inherit;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: var(--accent-hover); }
  .btn-success { background: var(--success); color: white; }
  .btn-success:hover { background: #15803d; }
  .btn-danger { background: var(--danger); color: white; }
  .btn-danger:hover { background: var(--danger-hover); }
  .btn-outline { background: transparent; color: white; border: 1px solid rgba(255,255,255,0.3); }
  .btn-outline:hover { background: rgba(255,255,255,0.1); }
  .btn-small { padding: 4px 10px; font-size: 0.75rem; }

  /* BOARD TITLE */
  .board-title {
    max-width: 1200px;
    margin: 16px auto 0;
    padding: 0 24px;
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .title-text {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--text);
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
    border: 2px solid transparent;
    transition: all 0.2s;
  }

  .title-text:hover {
    border-color: var(--border);
    background: #f8fafc;
  }

  .title-edit-btn {
    background: #e5e7eb !important;
    color: #374151 !important;
    border: none !important;
    font-size: 0.7rem !important;
  }

  .title-input {
    font-size: 1.4rem;
    font-weight: 700;
    font-family: inherit;
    color: var(--text);
    padding: 4px 8px;
    border: 2px solid var(--accent);
    border-radius: 6px;
    outline: none;
    width: 100%;
    max-width: 600px;
  }

  /* INSTRUCTIONS */
  .instructions {
    background: #dbeafe;
    border-left: 4px solid var(--accent);
    padding: 12px 20px;
    margin: 16px 24px;
    border-radius: 0 8px 8px 0;
    font-size: 0.85rem;
    color: #1e40af;
    line-height: 1.5;
  }

  /* BOARD */
  .board {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 24px 60px;
  }

  .category {
    margin-top: 20px;
    background: var(--card);
    border-radius: 12px;
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  .cat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    color: white;
    font-weight: 700;
    font-size: 0.9rem;
    letter-spacing: 0.03em;
  }

  .cat-header-actions {
    display: flex;
    gap: 6px;
  }

  .cat-header .btn-small {
    background: rgba(255,255,255,0.2);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
  }

  .cat-header .btn-small:hover {
    background: rgba(255,255,255,0.35);
  }

  .cat-header .btn-small.delete-cat {
    background: rgba(220,38,38,0.6);
    border-color: rgba(220,38,38,0.8);
  }

  .cat-header .btn-small.delete-cat:hover {
    background: rgba(220,38,38,0.9);
  }

  .cat-body {
    padding: 12px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    max-width: 100%;
  }

  /* SYMBOL CARD */
  .sym-card {
    width: calc((100% - 40px) / 6);
    min-width: 100px;
    border: 2px solid var(--border);
    border-radius: 8px;
    padding: 10px 6px;
    text-align: center;
    position: relative;
    background: #fafafa;
    transition: all 0.2s;
    cursor: grab;
    min-height: 80px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .sym-card.dragging {
    opacity: 0.4;
    border-color: var(--accent);
  }

  .sym-card.drag-over {
    border-color: var(--accent);
    background: #eff6ff;
    box-shadow: 0 0 0 2px var(--accent);
  }

  .sym-card:hover {
    border-color: var(--accent);
    box-shadow: var(--shadow);
  }

  .card-accent {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 5px;
    border-radius: 6px 6px 0 0;
  }

  .sym-card .symbol {
    font-weight: 700;
    margin-bottom: 4px;
    white-space: nowrap;
    max-width: 95%;
    overflow: hidden;
  }

  .sym-card .label {
    color: var(--text-dim);
    line-height: 1.2;
    white-space: nowrap;
    max-width: 95%;
    overflow: hidden;
  }

  .sym-card .move-arrows {
    position: absolute;
    bottom: 2px;
    left: 50%;
    transform: translateX(-50%);
    display: none;
    gap: 2px;
  }

  .sym-card:hover .move-arrows {
    display: flex;
  }

  .arrow-btn {
    width: 20px;
    height: 18px;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.6rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #e0e7ff;
    color: var(--accent);
    transition: all 0.15s;
  }

  .arrow-btn:hover { background: var(--accent); color: white; }

  .sym-card .card-actions {
    position: absolute;
    top: 2px;
    right: 2px;
    display: none;
    gap: 2px;
  }

  .sym-card:hover .card-actions {
    display: flex;
  }

  .icon-btn {
    width: 22px;
    height: 22px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
  }

  .icon-btn.edit { background: #dbeafe; color: var(--accent); }
  .icon-btn.edit:hover { background: var(--accent); color: white; }
  .icon-btn.delete { background: #fee2e2; color: var(--danger); }
  .icon-btn.delete:hover { background: var(--danger); color: white; }

  /* ADD BUTTON */
  .add-card {
    width: calc((100% - 40px) / 6);
    min-width: 100px;
    border: 2px dashed #ccc;
    border-radius: 8px;
    padding: 10px 6px;
    text-align: center;
    cursor: pointer;
    color: #aaa;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 70px;
  }

  .add-card:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: #f0f7ff;
  }

  .add-card .plus {
    font-size: 1.5rem;
    font-weight: 300;
    line-height: 1;
  }

  .add-card .add-text {
    font-size: 0.65rem;
    margin-top: 2px;
  }

  /* MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 200;
    justify-content: center;
    align-items: center;
  }

  .modal-overlay.active {
    display: flex;
  }

  .modal {
    background: white;
    border-radius: 12px;
    padding: 24px;
    width: 400px;
    max-width: 90vw;
    box-shadow: var(--shadow-lg);
  }

  .modal h3 {
    margin-bottom: 16px;
    font-size: 1.1rem;
  }

  .form-group {
    margin-bottom: 14px;
  }

  .form-group label {
    display: block;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-dim);
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .form-group input {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid var(--border);
    border-radius: 6px;
    font-family: inherit;
    font-size: 1rem;
    transition: border-color 0.2s;
  }

  .form-group input:focus {
    outline: none;
    border-color: var(--accent);
  }

  .modal-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
    margin-top: 18px;
  }

  .btn-cancel { background: #e5e7eb; color: #374151; }
  .btn-cancel:hover { background: #d1d5db; }

  /* LIBRARY PANEL */
  .library-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 150;
    justify-content: center;
    align-items: flex-start;
    padding-top: 60px;
  }

  .library-overlay.active { display: flex; }

  .library-panel {
    background: white;
    border-radius: 12px;
    width: 800px;
    max-width: 95vw;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: var(--shadow-lg);
    overflow: hidden;
  }

  .library-header {
    padding: 16px 20px;
    background: #1e293b;
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .library-header h2 { font-size: 1.1rem; }

  .library-search {
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    background: #f8fafc;
  }

  .library-search input {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid var(--border);
    border-radius: 8px;
    font-family: inherit;
    font-size: 1rem;
    transition: border-color 0.2s;
  }

  .library-search input:focus {
    outline: none;
    border-color: var(--accent);
  }

  .library-search .search-hint {
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-top: 4px;
  }

  .library-results {
    overflow-y: auto;
    padding: 12px 20px;
    flex: 1;
  }

  .lib-category-name {
    font-size: 0.75rem;
    font-weight: 700;
    color: white;
    padding: 4px 10px;
    border-radius: 4px;
    margin: 12px 0 6px;
    display: inline-block;
  }

  .lib-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 8px;
  }

  .lib-item {
    width: 140px;
    border: 2px solid var(--border);
    border-radius: 8px;
    padding: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: #fafafa;
  }

  .lib-item:hover {
    border-color: var(--accent);
    background: #eff6ff;
    box-shadow: var(--shadow);
  }

  .lib-item .lib-sym {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 2px;
  }

  .lib-item .lib-name {
    font-size: 0.6rem;
    color: var(--text-dim);
    line-height: 1.2;
  }

  .lib-item .lib-tags {
    font-size: 0.5rem;
    color: #9ca3af;
    margin-top: 2px;
    font-style: italic;
  }

  .lib-item .lib-add-btn {
    margin-top: 4px;
    font-size: 0.6rem;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 2px 8px;
    cursor: pointer;
    display: none;
  }

  .lib-item:hover .lib-add-btn { display: inline-block; }
  .lib-item .lib-add-btn:hover { background: var(--accent-hover); }

  .no-results {
    text-align: center;
    padding: 40px;
    color: var(--text-dim);
    font-size: 0.9rem;
  }

  /* CATEGORY PICKER IN LIBRARY */
  .lib-cat-picker {
    display: none;
    position: fixed;
    background: white;
    border-radius: 8px;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border);
    padding: 8px;
    z-index: 300;
    max-height: 300px;
    overflow-y: auto;
  }

  .lib-cat-picker.active { display: block; }

  .lib-cat-option {
    padding: 8px 12px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 0.8rem;
    transition: background 0.15s;
  }

  .lib-cat-option:hover { background: #eff6ff; }

  /* Print styles */
  @media print {
    .topbar, .instructions, .card-actions, .add-card, .cat-header-actions, .btn, .move-arrows, .title-edit-btn { display: none !important; }
    .category { box-shadow: none; border: 1px solid #ddd; page-break-inside: avoid; }
    body { background: white; }
    .board { padding: 0; }
  }

  /* EXPORT PREVIEW */
  .export-status {
    display: none;
    background: #dcfce7;
    border-left: 4px solid var(--success);
    padding: 12px 20px;
    margin: 16px 24px;
    border-radius: 0 8px 8px 0;
    font-size: 0.85rem;
    color: #166534;
  }

  .export-status.active { display: block; }

  /* Counter */
  .counter {
    font-size: 0.8rem;
    opacity: 0.7;
    font-weight: 400;
  }
</style>
</head>
<body>

<div class="topbar">
  <div>
    <h1>Calculus 2 ‚Äî AAC Board Editor</h1>
    <span class="counter" id="totalCount"></span>
  </div>
  <div class="topbar-actions">
    <button class="btn btn-outline" onclick="toggleLibrary()">üìö Symbol Library</button>
    <button class="btn btn-outline" onclick="addCategory()">+ Add Section</button>
    <button class="btn btn-outline" onclick="window.print()">üñ® Print</button>
    <button class="btn btn-success" onclick="exportPDF()">üìÑ Export PDF</button>
    <button class="btn btn-success" onclick="exportImages()">üñº Export Images</button>
    <button class="btn btn-success" onclick="exportJSON()">üíæ Save JSON</button>
    <button class="btn btn-primary" onclick="document.getElementById('importInput').click()">üìÇ Import JSON</button>
    <input type="file" id="importInput" accept=".json" style="display:none" onchange="importJSON(event)">
  </div>
</div>

<div class="instructions">
  <strong>How to use:</strong> Hover over any symbol to see edit ‚úèÔ∏è and delete üóë buttons. Click <strong>+ Add Symbol</strong> to add new ones. 
  Use <strong>+ Add Section</strong> to create new categories. <strong>Print</strong> for a clean printable version. 
  <strong>Save/Export</strong> saves your work as a JSON file you can reload later with <strong>Import</strong>.
</div>

<div class="export-status" id="exportStatus"></div>

<div class="board-title" id="boardTitleArea">
  <h1 class="title-text" id="boardTitle" onclick="editTitle()">CALCULUS 2 ‚Äî AAC COMMUNICATION BOARD</h1>
  <button class="btn btn-small btn-outline title-edit-btn" onclick="editTitle()">‚úèÔ∏è Edit Title</button>
</div>

<div class="board" id="board"></div>

<!-- SYMBOL LIBRARY -->
<div class="library-overlay" id="libraryOverlay">
  <div class="library-panel">
    <div class="library-header">
      <h2>üìö Calculus Symbol Library</h2>
      <button class="btn btn-outline btn-small" onclick="toggleLibrary()">‚úï Close</button>
    </div>
    <div class="library-search">
      <input type="text" id="libSearch" placeholder="Type to search... e.g. integral, derivative, sigma, limit, sum" oninput="filterLibrary()">
      <div class="search-hint">Search by name, description, or concept. Click any symbol to add it to your board.</div>
    </div>
    <div class="library-results" id="libResults"></div>
  </div>
</div>

<!-- CATEGORY PICKER (where to add from library) -->
<div class="lib-cat-picker" id="catPicker"></div>

<!-- SYMBOL EDIT MODAL -->
<div class="modal-overlay" id="symbolModal">
  <div class="modal">
    <h3 id="modalTitle">Edit Symbol</h3>
    <div class="form-group">
      <label>Symbol (what displays on the button)</label>
      <input type="text" id="symInput" placeholder="e.g. ‚à´, sin, x¬≤">
    </div>
    <div class="form-group">
      <label>English Name / Label</label>
      <input type="text" id="nameInput" placeholder="e.g. integral, sine, x squared">
    </div>
    <div class="modal-actions">
      <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" id="modalSave" onclick="saveSymbol()">Save</button>
    </div>
  </div>
</div>

<!-- CATEGORY MODAL -->
<div class="modal-overlay" id="catModal">
  <div class="modal">
    <h3 id="catModalTitle">Add New Section</h3>
    <div class="form-group">
      <label>Section Name</label>
      <input type="text" id="catNameInput" placeholder="e.g. NEW SYMBOLS">
    </div>
    <div class="form-group">
      <label>Color (hex)</label>
      <input type="color" id="catColorInput" value="#6366f1" style="height:40px;cursor:pointer;">
    </div>
    <div class="modal-actions">
      <button class="btn btn-cancel" onclick="closeCatModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveCategory()">Save</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
// ========== DATA ==========
let boardData = [
  {
    id: "numbers", name: "NUMBERS & DECIMALS", color: "#1565c0",
    symbols: [
      {s:"0",n:"zero"},{s:"1",n:"one"},{s:"2",n:"two"},{s:"3",n:"three"},{s:"4",n:"four"},
      {s:"5",n:"five"},{s:"6",n:"six"},{s:"7",n:"seven"},{s:"8",n:"eight"},{s:"9",n:"nine"},
      {s:".",n:"decimal point"},{s:"‚àí",n:"negative"},{s:"10",n:"ten"},{s:"100",n:"hundred"}
    ]
  },
  {
    id: "fractions", name: "COMMON FRACTIONS", color: "#c62828",
    symbols: [
      {s:"1/2",n:"one half"},{s:"1/3",n:"one third"},{s:"1/4",n:"one fourth"},
      {s:"2/3",n:"two thirds"},{s:"3/4",n:"three fourths"},{s:"1/5",n:"one fifth"},
      {s:"1/6",n:"one sixth"},{s:"1/8",n:"one eighth"},{s:"1/n",n:"one over n"},
      {s:"1/x",n:"one over x"},{s:"a/b",n:"a over b"},{s:"numerator",n:"numerator"},
      {s:"denominator",n:"denominator"},{s:"/",n:"fraction bar"}
    ]
  },
  {
    id: "variables", name: "VARIABLES & CONSTANTS", color: "#2e7d32",
    symbols: [
      {s:"x",n:"x"},{s:"y",n:"y"},{s:"z",n:"z"},{s:"u",n:"u"},{s:"v",n:"v"},
      {s:"t",n:"t"},{s:"n",n:"n"},{s:"k",n:"k"},{s:"a",n:"a"},{s:"b",n:"b"},
      {s:"c",n:"c"},{s:"r",n:"r"},{s:"f(x)",n:"f of x"},{s:"g(x)",n:"g of x"}
    ]
  },
  {
    id: "operators", name: "BASIC OPERATORS", color: "#e65100",
    symbols: [
      {s:"+",n:"plus"},{s:"‚àí",n:"minus"},{s:"√ó",n:"times"},
      {s:"√∑",n:"divided by"},{s:"=",n:"equals"},{s:"‚â†",n:"not equal"}
    ]
  },
  {
    id: "powers", name: "POWERS, ROOTS & LOGS", color: "#880e4f",
    symbols: [
      {s:"x¬≤",n:"x squared"},{s:"x¬≥",n:"x cubed"},{s:"x‚Åø",n:"x to the n"},
      {s:"x‚Åª¬π",n:"x to the negative 1"},{s:"‚àöx",n:"square root"},{s:"‚àõx",n:"cube root"},
      {s:"ln x",n:"natural log"},{s:"log x",n:"log base 10"},{s:"log‚Çê(x)",n:"log base a"},
      {s:"eÀ£",n:"e to the x"},{s:"aÀ£",n:"a to the x"}
    ]
  },
  {
    id: "calculus", name: "CALCULUS SYMBOLS", color: "#6a1b9a",
    symbols: [
      {s:"‚à´",n:"integral"},{s:"‚à´‚Çê·µá",n:"definite integral a to b"},
      {s:"dx",n:"with respect to x"},{s:"dy",n:"with respect to y"},
      {s:"du",n:"with respect to u"},{s:"dt",n:"with respect to t"},
      {s:"dŒ∏",n:"with respect to theta"},{s:"+ C",n:"plus constant C"},
      {s:"dy/dx",n:"derivative"},{s:"d/dx",n:"d over dx"},
      {s:"d¬≤y/dx¬≤",n:"second derivative"},{s:"lim",n:"limit"},
      {s:"‚Üí",n:"approaches"},{s:"n=1",n:"n equals 1"},
      {s:"n=0",n:"n equals 0"},{s:"‚àû",n:"infinity"},
      {s:"‚àí‚àû",n:"negative infinity"},{s:"|‚Çê·µá",n:"evaluated from a to b"},
      {s:"F(b)‚àíF(a)",n:"F of b minus F of a"},
      {s:"ds",n:"arc length element"},{s:"r¬≤",n:"r squared"},
      {s:"¬Ω‚à´r¬≤dŒ∏",n:"polar area formula"}
    ]
  },
  {
    id: "trig", name: "TRIG & INVERSE TRIG", color: "#00695c",
    symbols: [
      {s:"sin",n:"sine"},{s:"cos",n:"cosine"},{s:"tan",n:"tangent"},
      {s:"sec",n:"secant"},{s:"csc",n:"cosecant"},{s:"cot",n:"cotangent"},
      {s:"sin‚Åª¬π",n:"arcsine"},{s:"cos‚Åª¬π",n:"arccosine"},{s:"tan‚Åª¬π",n:"arctangent"},
      {s:"sec‚Åª¬π",n:"arcsecant"},{s:"sin¬≤",n:"sine squared"},{s:"cos¬≤",n:"cosine squared"},
      {s:"tan¬≤",n:"tangent squared"}
    ]
  },
  {
    id: "greek", name: "GREEK LETTERS & CONSTANTS", color: "#283593",
    symbols: [
      {s:"œÄ",n:"pi"},{s:"e",n:"Euler's number"},{s:"Œ∏",n:"theta"},
      {s:"Œî",n:"Delta"},{s:"Œ±",n:"alpha"},{s:"Œ≤",n:"beta"},
      {s:"Œµ",n:"epsilon"},{s:"œÅ",n:"rho"},{s:"Œ£",n:"sigma"}
    ]
  },
  {
    id: "grouping", name: "GROUPING & STRUCTURE", color: "#4e342e",
    symbols: [
      {s:"(",n:"open parenthesis"},{s:")",n:"close parenthesis"},
      {s:"[",n:"open bracket"},{s:"]",n:"close bracket"},
      {s:"{",n:"open brace"},{s:"}",n:"close brace"},
      {s:"|x|",n:"absolute value"}
    ]
  },
  {
    id: "comparison", name: "COMPARISON & LOGIC", color: "#33691e",
    symbols: [
      {s:"<",n:"less than"},{s:">",n:"greater than"},
      {s:"‚â§",n:"less than or equal"},{s:"‚â•",n:"greater than or equal"},
      {s:"‚âà",n:"approximately"},{s:"‚â†",n:"not equal"},
      {s:"if",n:"if / when"}
    ]
  },
  {
    id: "series", name: "SERIES & SEQUENCE TERMS", color: "#4527a0",
    symbols: [
      {s:"a‚Çô",n:"a sub n"},{s:"a‚Çô‚Çä‚ÇÅ",n:"a sub n plus 1"},
      {s:"S‚Çô",n:"S sub n"},{s:"S",n:"sum of series"},
      {s:"n!",n:"n factorial"},{s:"r",n:"common ratio"},
      {s:"|r|<1",n:"converges"},{s:"|r|‚â•1",n:"diverges"},
      {s:"R",n:"radius of convergence"},{s:"(‚àí1)‚Åø",n:"alternating sign"},
      {s:"DNE",n:"does not exist"},{s:"undefined",n:"undefined"}
    ]
  },
  {
    id: "quick", name: "QUICK PHRASES (SPEED BUILDERS)", color: "#004d40",
    symbols: [
      {s:"from 0 to 1",n:"from 0 to 1"},{s:"from 0 to ‚àû",n:"from 0 to infinity"},
      {s:"from 0 to œÄ",n:"from 0 to pi"},{s:"from 0 to 2œÄ",n:"from 0 to 2 pi"},
      {s:"from a to b",n:"from a to b"},
      {s:"as n‚Üí‚àû",n:"as n approaches infinity"},{s:"as x‚Üí0",n:"as x approaches 0"},
      {s:"as x‚Üí‚àû",n:"as x approaches infinity"},{s:"n=1 to ‚àû",n:"n equals 1 to infinity"},
      {s:"+ C",n:"plus C"},{s:"= 0",n:"equals zero"},
      {s:"= 1",n:"equals one"},{s:"= ‚àû",n:"equals infinity"}
    ]
  },
  {
    id: "answers", name: "ANSWER PHRASES", color: "#bf360c",
    symbols: [
      {s:"converges",n:"converges"},{s:"diverges",n:"diverges"},
      {s:"converges to",n:"converges to"},{s:"diverges to ‚àû",n:"diverges to infinity"},
      {s:"absolutely",n:"converges absolutely"},{s:"conditionally",n:"converges conditionally"}
    ]
  }
];

// ========== STATE ==========
let editingCatIdx = null;
let editingSymIdx = null;
let isAdding = false;

// ========== RENDER ==========
function render() {
  const board = document.getElementById('board');
  let total = 0;
  board.innerHTML = '';

  boardData.forEach((cat, catIdx) => {
    const catDiv = document.createElement('div');
    catDiv.className = 'category';

    // Header
    const header = document.createElement('div');
    header.className = 'cat-header';
    header.style.background = cat.color;
    header.innerHTML = `
      <span>${cat.name} <span class="counter">(${cat.symbols.length})</span></span>
      <div class="cat-header-actions">
        <button class="btn-small" onclick="moveCategoryUp(${catIdx})" title="Move section up" ${catIdx === 0 ? 'disabled style="opacity:0.3;cursor:default"' : ''}>‚ñ≤</button>
        <button class="btn-small" onclick="moveCategoryDown(${catIdx})" title="Move section down" ${catIdx === boardData.length - 1 ? 'disabled style="opacity:0.3;cursor:default"' : ''}>‚ñº</button>
        <button class="btn-small" onclick="editCategoryName(${catIdx})" title="Rename section">‚úèÔ∏è</button>
        <button class="btn-small delete-cat" onclick="deleteCategory(${catIdx})" title="Delete entire section">üóë</button>
      </div>
    `;
    catDiv.appendChild(header);

    // Body with symbols
    const body = document.createElement('div');
    body.className = 'cat-body';

    cat.symbols.forEach((sym, symIdx) => {
      total++;
      const card = document.createElement('div');
      card.className = 'sym-card';
      card.draggable = true;
      card.dataset.catIdx = catIdx;
      card.dataset.symIdx = symIdx;

      // Drag events
      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragover', handleDragOver);
      card.addEventListener('dragenter', handleDragEnter);
      card.addEventListener('dragleave', handleDragLeave);
      card.addEventListener('drop', handleDrop);
      card.addEventListener('dragend', handleDragEnd);

      // Auto-size symbol text
      let symFontSize = 1.4;
      if (sym.s.length > 12) symFontSize = 0.7;
      else if (sym.s.length > 9) symFontSize = 0.85;
      else if (sym.s.length > 6) symFontSize = 1.0;
      else if (sym.s.length > 4) symFontSize = 1.15;

      // Auto-size label text
      let lblFontSize = 0.65;
      if (sym.n.length > 22) lblFontSize = 0.48;
      else if (sym.n.length > 16) lblFontSize = 0.52;
      else if (sym.n.length > 12) lblFontSize = 0.58;

      const isFirst = symIdx === 0;
      const isLast = symIdx === cat.symbols.length - 1;

      card.innerHTML = `
        <div class="card-accent" style="background:${cat.color}"></div>
        <div class="card-actions">
          <button class="icon-btn edit" onclick="editSymbol(${catIdx},${symIdx})" title="Edit">‚úè</button>
          <button class="icon-btn delete" onclick="deleteSymbol(${catIdx},${symIdx})" title="Delete">‚úï</button>
        </div>
        <div class="symbol" style="font-size:${symFontSize}rem">${escapeHtml(sym.s)}</div>
        <div class="label" style="font-size:${lblFontSize}rem">${escapeHtml(sym.n)}</div>
        <div class="move-arrows">
          <button class="arrow-btn" onclick="moveSymbol(${catIdx},${symIdx},-1)" title="Move left" ${isFirst ? 'disabled style="opacity:0.3"' : ''}>‚óÄ</button>
          <button class="arrow-btn" onclick="moveSymbol(${catIdx},${symIdx},1)" title="Move right" ${isLast ? 'disabled style="opacity:0.3"' : ''}>‚ñ∂</button>
        </div>
      `;
      body.appendChild(card);
    });

    // Add button
    const addCard = document.createElement('div');
    addCard.className = 'add-card';
    addCard.onclick = () => addSymbol(catIdx);
    addCard.innerHTML = `<div class="plus">+</div><div class="add-text">Add Symbol</div>`;
    body.appendChild(addCard);

    catDiv.appendChild(body);
    board.appendChild(catDiv);
  });

  document.getElementById('totalCount').textContent = `${total} symbols total`;
}

function escapeHtml(str) {
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ========== BOARD TITLE ==========
let boardTitle = "CALCULUS 2 ‚Äî AAC COMMUNICATION BOARD";

function editTitle() {
  const titleArea = document.getElementById('boardTitleArea');
  titleArea.innerHTML = `
    <input type="text" class="title-input" id="titleInput" value="${boardTitle}" 
      onkeydown="if(event.key==='Enter')saveTitle()" onblur="saveTitle()">
    <button class="btn btn-small btn-primary" onclick="saveTitle()">Save</button>
  `;
  document.getElementById('titleInput').focus();
  document.getElementById('titleInput').select();
}

function saveTitle() {
  const input = document.getElementById('titleInput');
  if (input) {
    boardTitle = input.value.trim() || "CALCULUS 2 ‚Äî AAC COMMUNICATION BOARD";
  }
  const titleArea = document.getElementById('boardTitleArea');
  titleArea.innerHTML = `
    <h1 class="title-text" id="boardTitle" onclick="editTitle()">${escapeHtml(boardTitle)}</h1>
    <button class="btn btn-small btn-outline title-edit-btn" onclick="editTitle()">‚úèÔ∏è Edit Title</button>
  `;
}

// ========== SYMBOL LIBRARY ==========
const LIBRARY = [
  // === BASIC MATH ===
  {cat:"Basic Math", color:"#e65100", sym:"+", name:"plus", tags:"add addition sum positive"},
  {cat:"Basic Math", color:"#e65100", sym:"‚àí", name:"minus", tags:"subtract subtraction negative"},
  {cat:"Basic Math", color:"#e65100", sym:"√ó", name:"times", tags:"multiply multiplication product"},
  {cat:"Basic Math", color:"#e65100", sym:"√∑", name:"divided by", tags:"divide division quotient"},
  {cat:"Basic Math", color:"#e65100", sym:"=", name:"equals", tags:"equal same"},
  {cat:"Basic Math", color:"#e65100", sym:"‚â†", name:"not equal", tags:"unequal different"},
  {cat:"Basic Math", color:"#e65100", sym:"¬±", name:"plus or minus", tags:"plus minus both"},
  {cat:"Basic Math", color:"#e65100", sym:"‚àù", name:"proportional to", tags:"proportion"},

  // === NUMBERS ===
  {cat:"Numbers", color:"#1565c0", sym:"0", name:"zero", tags:"number digit"},
  {cat:"Numbers", color:"#1565c0", sym:"1", name:"one", tags:"number digit"},
  {cat:"Numbers", color:"#1565c0", sym:"2", name:"two", tags:"number digit"},
  {cat:"Numbers", color:"#1565c0", sym:"3", name:"three", tags:"number digit"},
  {cat:"Numbers", color:"#1565c0", sym:"4", name:"four", tags:"number digit"},
  {cat:"Numbers", color:"#1565c0", sym:"5", name:"five", tags:"number digit"},
  {cat:"Numbers", color:"#1565c0", sym:"6", name:"six", tags:"number digit"},
  {cat:"Numbers", color:"#1565c0", sym:"7", name:"seven", tags:"number digit"},
  {cat:"Numbers", color:"#1565c0", sym:"8", name:"eight", tags:"number digit"},
  {cat:"Numbers", color:"#1565c0", sym:"9", name:"nine", tags:"number digit"},
  {cat:"Numbers", color:"#1565c0", sym:"10", name:"ten", tags:"number"},
  {cat:"Numbers", color:"#1565c0", sym:"100", name:"hundred", tags:"number"},
  {cat:"Numbers", color:"#1565c0", sym:".", name:"decimal point", tags:"dot period"},
  {cat:"Numbers", color:"#1565c0", sym:"‚àí", name:"negative sign", tags:"minus negative"},

  // === FRACTIONS ===
  {cat:"Fractions", color:"#c62828", sym:"1/2", name:"one half", tags:"fraction half"},
  {cat:"Fractions", color:"#c62828", sym:"1/3", name:"one third", tags:"fraction third"},
  {cat:"Fractions", color:"#c62828", sym:"1/4", name:"one fourth", tags:"fraction quarter fourth"},
  {cat:"Fractions", color:"#c62828", sym:"2/3", name:"two thirds", tags:"fraction"},
  {cat:"Fractions", color:"#c62828", sym:"3/4", name:"three fourths", tags:"fraction quarter"},
  {cat:"Fractions", color:"#c62828", sym:"1/5", name:"one fifth", tags:"fraction"},
  {cat:"Fractions", color:"#c62828", sym:"1/6", name:"one sixth", tags:"fraction"},
  {cat:"Fractions", color:"#c62828", sym:"1/8", name:"one eighth", tags:"fraction"},
  {cat:"Fractions", color:"#c62828", sym:"1/n", name:"one over n", tags:"fraction reciprocal"},
  {cat:"Fractions", color:"#c62828", sym:"1/x", name:"one over x", tags:"fraction reciprocal"},
  {cat:"Fractions", color:"#c62828", sym:"a/b", name:"a over b", tags:"fraction general"},
  {cat:"Fractions", color:"#c62828", sym:"numerator", name:"numerator", tags:"top fraction"},
  {cat:"Fractions", color:"#c62828", sym:"denominator", name:"denominator", tags:"bottom fraction"},
  {cat:"Fractions", color:"#c62828", sym:"/", name:"fraction bar", tags:"divide over"},

  // === VARIABLES ===
  {cat:"Variables", color:"#2e7d32", sym:"x", name:"x", tags:"variable unknown"},
  {cat:"Variables", color:"#2e7d32", sym:"y", name:"y", tags:"variable unknown"},
  {cat:"Variables", color:"#2e7d32", sym:"z", name:"z", tags:"variable unknown"},
  {cat:"Variables", color:"#2e7d32", sym:"u", name:"u", tags:"variable substitution"},
  {cat:"Variables", color:"#2e7d32", sym:"v", name:"v", tags:"variable"},
  {cat:"Variables", color:"#2e7d32", sym:"t", name:"t", tags:"variable parameter time"},
  {cat:"Variables", color:"#2e7d32", sym:"n", name:"n", tags:"variable index integer"},
  {cat:"Variables", color:"#2e7d32", sym:"k", name:"k", tags:"variable index counter"},
  {cat:"Variables", color:"#2e7d32", sym:"a", name:"a", tags:"variable constant coefficient"},
  {cat:"Variables", color:"#2e7d32", sym:"b", name:"b", tags:"variable constant coefficient"},
  {cat:"Variables", color:"#2e7d32", sym:"c", name:"c", tags:"variable constant coefficient"},
  {cat:"Variables", color:"#2e7d32", sym:"r", name:"r", tags:"variable ratio radius"},
  {cat:"Variables", color:"#2e7d32", sym:"f(x)", name:"f of x", tags:"function"},
  {cat:"Variables", color:"#2e7d32", sym:"g(x)", name:"g of x", tags:"function"},
  {cat:"Variables", color:"#2e7d32", sym:"h(x)", name:"h of x", tags:"function"},

  // === POWERS ROOTS LOGS ===
  {cat:"Powers & Roots", color:"#880e4f", sym:"x¬≤", name:"x squared", tags:"power exponent square second"},
  {cat:"Powers & Roots", color:"#880e4f", sym:"x¬≥", name:"x cubed", tags:"power exponent cube third"},
  {cat:"Powers & Roots", color:"#880e4f", sym:"x‚Åø", name:"x to the n", tags:"power exponent general"},
  {cat:"Powers & Roots", color:"#880e4f", sym:"x‚Åª¬π", name:"x to the negative 1", tags:"power inverse reciprocal"},
  {cat:"Powers & Roots", color:"#880e4f", sym:"x‚Åª¬≤", name:"x to the negative 2", tags:"power inverse"},
  {cat:"Powers & Roots", color:"#880e4f", sym:"‚àöx", name:"square root", tags:"radical root sqrt"},
  {cat:"Powers & Roots", color:"#880e4f", sym:"‚àõx", name:"cube root", tags:"radical root cbrt third"},
  {cat:"Powers & Roots", color:"#880e4f", sym:"‚Åø‚àöx", name:"nth root", tags:"radical root general"},
  {cat:"Powers & Roots", color:"#880e4f", sym:"ln x", name:"natural log", tags:"logarithm natural ln e base"},
  {cat:"Powers & Roots", color:"#880e4f", sym:"log x", name:"log base 10", tags:"logarithm common"},
  {cat:"Powers & Roots", color:"#880e4f", sym:"log‚Çê(x)", name:"log base a", tags:"logarithm general base"},
  {cat:"Powers & Roots", color:"#880e4f", sym:"log‚ÇÇ(x)", name:"log base 2", tags:"logarithm binary"},
  {cat:"Powers & Roots", color:"#880e4f", sym:"eÀ£", name:"e to the x", tags:"exponential euler natural"},
  {cat:"Powers & Roots", color:"#880e4f", sym:"aÀ£", name:"a to the x", tags:"exponential general"},
  {cat:"Powers & Roots", color:"#880e4f", sym:"2‚Åø", name:"2 to the n", tags:"exponential power"},
  {cat:"Powers & Roots", color:"#880e4f", sym:"10‚Åø", name:"10 to the n", tags:"exponential power"},

  // === CALCULUS ‚Äî INTEGRALS ===
  {cat:"Integrals", color:"#6a1b9a", sym:"‚à´", name:"integral", tags:"integrate antiderivative area"},
  {cat:"Integrals", color:"#6a1b9a", sym:"‚à´‚Çê·µá", name:"definite integral a to b", tags:"integrate definite bounds limits area"},
  {cat:"Integrals", color:"#6a1b9a", sym:"‚à¨", name:"double integral", tags:"integrate two dimensional area volume"},
  {cat:"Integrals", color:"#6a1b9a", sym:"‚à≠", name:"triple integral", tags:"integrate three dimensional volume"},
  {cat:"Integrals", color:"#6a1b9a", sym:"‚àÆ", name:"contour integral", tags:"integrate closed loop line path"},
  {cat:"Integrals", color:"#6a1b9a", sym:"dx", name:"with respect to x", tags:"differential variable integration"},
  {cat:"Integrals", color:"#6a1b9a", sym:"dy", name:"with respect to y", tags:"differential variable integration"},
  {cat:"Integrals", color:"#6a1b9a", sym:"du", name:"with respect to u", tags:"differential substitution"},
  {cat:"Integrals", color:"#6a1b9a", sym:"dt", name:"with respect to t", tags:"differential time parameter"},
  {cat:"Integrals", color:"#6a1b9a", sym:"dŒ∏", name:"with respect to theta", tags:"differential angle polar"},
  {cat:"Integrals", color:"#6a1b9a", sym:"dr", name:"with respect to r", tags:"differential radius polar"},
  {cat:"Integrals", color:"#6a1b9a", sym:"+ C", name:"plus constant C", tags:"constant integration indefinite"},
  {cat:"Integrals", color:"#6a1b9a", sym:"|‚Çê·µá", name:"evaluated from a to b", tags:"evaluate bounds fundamental theorem"},
  {cat:"Integrals", color:"#6a1b9a", sym:"F(b)‚àíF(a)", name:"F of b minus F of a", tags:"fundamental theorem calculus evaluate"},

  // === CALCULUS ‚Äî DERIVATIVES ===
  {cat:"Derivatives", color:"#7b1fa2", sym:"dy/dx", name:"derivative", tags:"derivative rate change slope dydx"},
  {cat:"Derivatives", color:"#7b1fa2", sym:"d/dx", name:"d over dx", tags:"derivative operator differentiate"},
  {cat:"Derivatives", color:"#7b1fa2", sym:"d¬≤y/dx¬≤", name:"second derivative", tags:"derivative second concavity acceleration"},
  {cat:"Derivatives", color:"#7b1fa2", sym:"d‚Åøy/dx‚Åø", name:"nth derivative", tags:"derivative higher order"},
  {cat:"Derivatives", color:"#7b1fa2", sym:"f'(x)", name:"f prime of x", tags:"derivative prime notation first"},
  {cat:"Derivatives", color:"#7b1fa2", sym:"f''(x)", name:"f double prime", tags:"derivative second prime notation"},
  {cat:"Derivatives", color:"#7b1fa2", sym:"dy/dt", name:"dy over dt", tags:"derivative time rate parametric"},
  {cat:"Derivatives", color:"#7b1fa2", sym:"dx/dt", name:"dx over dt", tags:"derivative time rate parametric"},
  {cat:"Derivatives", color:"#7b1fa2", sym:"‚àÇ/‚àÇx", name:"partial derivative", tags:"partial multivariable"},
  {cat:"Derivatives", color:"#7b1fa2", sym:"‚àá", name:"nabla / gradient", tags:"gradient del vector calculus"},

  // === LIMITS ===
  {cat:"Limits", color:"#ad1457", sym:"lim", name:"limit", tags:"limit approach tends"},
  {cat:"Limits", color:"#ad1457", sym:"‚Üí", name:"approaches", tags:"arrow tends goes to limit"},
  {cat:"Limits", color:"#ad1457", sym:"‚àû", name:"infinity", tags:"infinite forever unbounded"},
  {cat:"Limits", color:"#ad1457", sym:"‚àí‚àû", name:"negative infinity", tags:"infinite negative unbounded"},
  {cat:"Limits", color:"#ad1457", sym:"0‚Å∫", name:"zero from the right", tags:"limit right side positive approach"},
  {cat:"Limits", color:"#ad1457", sym:"0‚Åª", name:"zero from the left", tags:"limit left side negative approach"},
  {cat:"Limits", color:"#ad1457", sym:"DNE", name:"does not exist", tags:"limit undefined no limit"},
  {cat:"Limits", color:"#ad1457", sym:"L'H√¥pital", name:"L'Hopital's rule", tags:"limit indeterminate 0/0 infinity/infinity hospital"},

  // === SUMMATION & SERIES ===
  {cat:"Series & Sequences", color:"#4527a0", sym:"Œ£", name:"sigma / summation", tags:"sum series sigma add total"},
  {cat:"Series & Sequences", color:"#4527a0", sym:"Œ†", name:"pi / product", tags:"product multiply series"},
  {cat:"Series & Sequences", color:"#4527a0", sym:"a‚Çô", name:"a sub n", tags:"term sequence nth general"},
  {cat:"Series & Sequences", color:"#4527a0", sym:"a‚Çô‚Çä‚ÇÅ", name:"a sub n plus 1", tags:"term next sequence"},
  {cat:"Series & Sequences", color:"#4527a0", sym:"S‚Çô", name:"S sub n", tags:"partial sum series"},
  {cat:"Series & Sequences", color:"#4527a0", sym:"S", name:"sum of series", tags:"total sum infinite"},
  {cat:"Series & Sequences", color:"#4527a0", sym:"n!", name:"n factorial", tags:"factorial multiply product permutation"},
  {cat:"Series & Sequences", color:"#4527a0", sym:"r", name:"common ratio", tags:"ratio geometric series"},
  {cat:"Series & Sequences", color:"#4527a0", sym:"|r|<1", name:"converges", tags:"convergence ratio test geometric"},
  {cat:"Series & Sequences", color:"#4527a0", sym:"|r|‚â•1", name:"diverges", tags:"divergence ratio test geometric"},
  {cat:"Series & Sequences", color:"#4527a0", sym:"R", name:"radius of convergence", tags:"radius power series interval"},
  {cat:"Series & Sequences", color:"#4527a0", sym:"(‚àí1)‚Åø", name:"alternating sign", tags:"alternating series sign change"},
  {cat:"Series & Sequences", color:"#4527a0", sym:"n=1", name:"n equals 1", tags:"index start summation"},
  {cat:"Series & Sequences", color:"#4527a0", sym:"n=0", name:"n equals 0", tags:"index start summation"},
  {cat:"Series & Sequences", color:"#4527a0", sym:"‚àëa‚Çô", name:"sum of a sub n", tags:"series summation terms"},
  {cat:"Series & Sequences", color:"#4527a0", sym:"‚àë‚àû", name:"infinite sum", tags:"series infinite summation"},
  {cat:"Series & Sequences", color:"#4527a0", sym:"converges", name:"converges", tags:"convergence limit finite"},
  {cat:"Series & Sequences", color:"#4527a0", sym:"diverges", name:"diverges", tags:"divergence infinite no limit"},

  // === POWER SERIES ===
  {cat:"Power Series", color:"#311b92", sym:"‚àëc‚Çôx‚Åø", name:"power series", tags:"power series coefficients taylor"},
  {cat:"Power Series", color:"#311b92", sym:"‚àëc‚Çô(x‚àía)‚Åø", name:"power series centered at a", tags:"power series center shift"},
  {cat:"Power Series", color:"#311b92", sym:"eÀ£ = ‚àëx‚Åø/n!", name:"Taylor series for e^x", tags:"taylor maclaurin exponential series expansion"},
  {cat:"Power Series", color:"#311b92", sym:"sin x = ‚àë...", name:"Taylor series for sin x", tags:"taylor maclaurin sine series expansion"},
  {cat:"Power Series", color:"#311b92", sym:"cos x = ‚àë...", name:"Taylor series for cos x", tags:"taylor maclaurin cosine series expansion"},
  {cat:"Power Series", color:"#311b92", sym:"1/(1‚àíx)", name:"geometric series sum", tags:"geometric series closed form"},
  {cat:"Power Series", color:"#311b92", sym:"[‚àíR, R]", name:"interval of convergence", tags:"interval radius convergence power"},
  {cat:"Power Series", color:"#311b92", sym:"T‚Çô(x)", name:"Taylor polynomial degree n", tags:"taylor polynomial approximation"},

  // === TRIGONOMETRY ===
  {cat:"Trigonometry", color:"#00695c", sym:"sin", name:"sine", tags:"trig sin opposite hypotenuse"},
  {cat:"Trigonometry", color:"#00695c", sym:"cos", name:"cosine", tags:"trig cos adjacent hypotenuse"},
  {cat:"Trigonometry", color:"#00695c", sym:"tan", name:"tangent", tags:"trig tan opposite adjacent"},
  {cat:"Trigonometry", color:"#00695c", sym:"sec", name:"secant", tags:"trig sec reciprocal cosine"},
  {cat:"Trigonometry", color:"#00695c", sym:"csc", name:"cosecant", tags:"trig csc reciprocal sine"},
  {cat:"Trigonometry", color:"#00695c", sym:"cot", name:"cotangent", tags:"trig cot reciprocal tangent"},
  {cat:"Trigonometry", color:"#00695c", sym:"sin‚Åª¬π", name:"arcsine", tags:"inverse trig arcsin"},
  {cat:"Trigonometry", color:"#00695c", sym:"cos‚Åª¬π", name:"arccosine", tags:"inverse trig arccos"},
  {cat:"Trigonometry", color:"#00695c", sym:"tan‚Åª¬π", name:"arctangent", tags:"inverse trig arctan"},
  {cat:"Trigonometry", color:"#00695c", sym:"sec‚Åª¬π", name:"arcsecant", tags:"inverse trig arcsec"},
  {cat:"Trigonometry", color:"#00695c", sym:"sin¬≤", name:"sine squared", tags:"trig squared power"},
  {cat:"Trigonometry", color:"#00695c", sym:"cos¬≤", name:"cosine squared", tags:"trig squared power"},
  {cat:"Trigonometry", color:"#00695c", sym:"tan¬≤", name:"tangent squared", tags:"trig squared power"},
  {cat:"Trigonometry", color:"#00695c", sym:"sec¬≤", name:"secant squared", tags:"trig squared power derivative tangent"},
  {cat:"Trigonometry", color:"#00695c", sym:"csc¬≤", name:"cosecant squared", tags:"trig squared power"},
  {cat:"Trigonometry", color:"#00695c", sym:"sin(2x)", name:"sine of 2x", tags:"trig double angle"},
  {cat:"Trigonometry", color:"#00695c", sym:"cos(2x)", name:"cosine of 2x", tags:"trig double angle"},

  // === HYPERBOLIC ===
  {cat:"Hyperbolic", color:"#f57f17", sym:"sinh", name:"hyperbolic sine", tags:"hyp sinh"},
  {cat:"Hyperbolic", color:"#f57f17", sym:"cosh", name:"hyperbolic cosine", tags:"hyp cosh"},
  {cat:"Hyperbolic", color:"#f57f17", sym:"tanh", name:"hyperbolic tangent", tags:"hyp tanh"},
  {cat:"Hyperbolic", color:"#f57f17", sym:"sech", name:"hyperbolic secant", tags:"hyp sech"},
  {cat:"Hyperbolic", color:"#f57f17", sym:"csch", name:"hyperbolic cosecant", tags:"hyp csch"},
  {cat:"Hyperbolic", color:"#f57f17", sym:"coth", name:"hyperbolic cotangent", tags:"hyp coth"},

  // === GREEK LETTERS ===
  {cat:"Greek Letters", color:"#283593", sym:"œÄ", name:"pi", tags:"greek pi circle 3.14159"},
  {cat:"Greek Letters", color:"#283593", sym:"e", name:"Euler's number", tags:"euler natural 2.718 constant"},
  {cat:"Greek Letters", color:"#283593", sym:"Œ∏", name:"theta", tags:"greek angle polar"},
  {cat:"Greek Letters", color:"#283593", sym:"Œî", name:"Delta", tags:"greek change difference"},
  {cat:"Greek Letters", color:"#283593", sym:"Œ±", name:"alpha", tags:"greek"},
  {cat:"Greek Letters", color:"#283593", sym:"Œ≤", name:"beta", tags:"greek"},
  {cat:"Greek Letters", color:"#283593", sym:"Œ≥", name:"gamma", tags:"greek"},
  {cat:"Greek Letters", color:"#283593", sym:"Œµ", name:"epsilon", tags:"greek small error limit"},
  {cat:"Greek Letters", color:"#283593", sym:"œÅ", name:"rho", tags:"greek density radius"},
  {cat:"Greek Letters", color:"#283593", sym:"œÉ", name:"sigma (lowercase)", tags:"greek standard deviation"},
  {cat:"Greek Letters", color:"#283593", sym:"Œ£", name:"sigma (uppercase)", tags:"greek summation sum"},
  {cat:"Greek Letters", color:"#283593", sym:"œÑ", name:"tau", tags:"greek torque time"},
  {cat:"Greek Letters", color:"#283593", sym:"œÜ", name:"phi", tags:"greek angle golden ratio"},
  {cat:"Greek Letters", color:"#283593", sym:"œâ", name:"omega", tags:"greek angular velocity frequency"},
  {cat:"Greek Letters", color:"#283593", sym:"Œª", name:"lambda", tags:"greek wavelength eigenvalue"},
  {cat:"Greek Letters", color:"#283593", sym:"Œº", name:"mu", tags:"greek mean micro"},

  // === COMPARISON & LOGIC ===
  {cat:"Comparison", color:"#33691e", sym:"<", name:"less than", tags:"compare inequality smaller"},
  {cat:"Comparison", color:"#33691e", sym:">", name:"greater than", tags:"compare inequality larger bigger"},
  {cat:"Comparison", color:"#33691e", sym:"‚â§", name:"less than or equal", tags:"compare inequality"},
  {cat:"Comparison", color:"#33691e", sym:"‚â•", name:"greater than or equal", tags:"compare inequality"},
  {cat:"Comparison", color:"#33691e", sym:"‚âà", name:"approximately", tags:"compare about close nearly"},
  {cat:"Comparison", color:"#33691e", sym:"‚â°", name:"identical to", tags:"compare congruent same"},
  {cat:"Comparison", color:"#33691e", sym:"‚àà", name:"element of", tags:"set member belongs"},
  {cat:"Comparison", color:"#33691e", sym:"‚äÇ", name:"subset of", tags:"set contained"},
  {cat:"Comparison", color:"#33691e", sym:"‚à™", name:"union", tags:"set combine or"},
  {cat:"Comparison", color:"#33691e", sym:"‚à©", name:"intersection", tags:"set overlap and"},
  {cat:"Comparison", color:"#33691e", sym:"‚àÖ", name:"empty set", tags:"set nothing null"},
  {cat:"Comparison", color:"#33691e", sym:"‚àÄ", name:"for all", tags:"logic universal every"},
  {cat:"Comparison", color:"#33691e", sym:"‚àÉ", name:"there exists", tags:"logic existential some"},
  {cat:"Comparison", color:"#33691e", sym:"‚à¥", name:"therefore", tags:"logic conclusion proof"},
  {cat:"Comparison", color:"#33691e", sym:"if", name:"if / when", tags:"conditional logic"},

  // === GROUPING ===
  {cat:"Grouping", color:"#4e342e", sym:"(", name:"open parenthesis", tags:"group paren left"},
  {cat:"Grouping", color:"#4e342e", sym:")", name:"close parenthesis", tags:"group paren right"},
  {cat:"Grouping", color:"#4e342e", sym:"[", name:"open bracket", tags:"group bracket square left"},
  {cat:"Grouping", color:"#4e342e", sym:"]", name:"close bracket", tags:"group bracket square right"},
  {cat:"Grouping", color:"#4e342e", sym:"{", name:"open brace", tags:"group curly left set"},
  {cat:"Grouping", color:"#4e342e", sym:"}", name:"close brace", tags:"group curly right set"},
  {cat:"Grouping", color:"#4e342e", sym:"|x|", name:"absolute value", tags:"absolute magnitude distance"},
  {cat:"Grouping", color:"#4e342e", sym:"| |", name:"evaluated at", tags:"evaluate bar boundary"},

  // === PARAMETRIC & POLAR ===
  {cat:"Parametric & Polar", color:"#0277bd", sym:"r(Œ∏)", name:"r of theta", tags:"polar function radius angle"},
  {cat:"Parametric & Polar", color:"#0277bd", sym:"x(t)", name:"x of t", tags:"parametric horizontal time"},
  {cat:"Parametric & Polar", color:"#0277bd", sym:"y(t)", name:"y of t", tags:"parametric vertical time"},
  {cat:"Parametric & Polar", color:"#0277bd", sym:"dy/dt", name:"dy over dt", tags:"parametric derivative vertical"},
  {cat:"Parametric & Polar", color:"#0277bd", sym:"dx/dt", name:"dx over dt", tags:"parametric derivative horizontal"},
  {cat:"Parametric & Polar", color:"#0277bd", sym:"ds", name:"arc length element", tags:"arc length differential parametric"},
  {cat:"Parametric & Polar", color:"#0277bd", sym:"r¬≤", name:"r squared", tags:"polar radius squared area"},
  {cat:"Parametric & Polar", color:"#0277bd", sym:"¬Ω‚à´r¬≤dŒ∏", name:"polar area formula", tags:"polar area integral"},
  {cat:"Parametric & Polar", color:"#0277bd", sym:"r = cos Œ∏", name:"r equals cos theta", tags:"polar curve circle"},
  {cat:"Parametric & Polar", color:"#0277bd", sym:"r = sin Œ∏", name:"r equals sin theta", tags:"polar curve circle"},

  // === INTEGRATION TECHNIQUES ===
  {cat:"Techniques", color:"#f9a825", sym:"by parts", name:"integration by parts", tags:"technique uv integral product"},
  {cat:"Techniques", color:"#f9a825", sym:"u-sub", name:"u substitution", tags:"technique substitution change variable"},
  {cat:"Techniques", color:"#f9a825", sym:"trig sub", name:"trig substitution", tags:"technique trigonometric substitution sqrt"},
  {cat:"Techniques", color:"#f9a825", sym:"partial frac", name:"partial fractions", tags:"technique decomposition rational"},
  {cat:"Techniques", color:"#f9a825", sym:"improper", name:"improper integral", tags:"technique infinite bound diverge converge"},
  {cat:"Techniques", color:"#f9a825", sym:"L'H√¥pital", name:"L'Hopital's rule", tags:"technique limit indeterminate hospital"},
  {cat:"Techniques", color:"#f9a825", sym:"tabular", name:"tabular method", tags:"technique integration parts table repeated"},
  {cat:"Techniques", color:"#f9a825", sym:"shells", name:"shell method", tags:"technique volume revolution cylindrical"},
  {cat:"Techniques", color:"#f9a825", sym:"disks", name:"disk method", tags:"technique volume revolution circular"},
  {cat:"Techniques", color:"#f9a825", sym:"washers", name:"washer method", tags:"technique volume revolution hollow"},

  // === CONVERGENCE TESTS ===
  {cat:"Convergence Tests", color:"#bf360c", sym:"ratio test", name:"ratio test", tags:"series convergence a‚Çô‚Çä‚ÇÅ/a‚Çô limit"},
  {cat:"Convergence Tests", color:"#bf360c", sym:"root test", name:"root test", tags:"series convergence nth root limit"},
  {cat:"Convergence Tests", color:"#bf360c", sym:"integral test", name:"integral test", tags:"series convergence integral compare"},
  {cat:"Convergence Tests", color:"#bf360c", sym:"comparison", name:"comparison test", tags:"series convergence compare larger smaller"},
  {cat:"Convergence Tests", color:"#bf360c", sym:"limit comp", name:"limit comparison", tags:"series convergence compare limit ratio"},
  {cat:"Convergence Tests", color:"#bf360c", sym:"alternating", name:"alternating series test", tags:"series convergence sign change leibniz"},
  {cat:"Convergence Tests", color:"#bf360c", sym:"p-series", name:"p-series test", tags:"series convergence 1/n·µñ"},
  {cat:"Convergence Tests", color:"#bf360c", sym:"geometric", name:"geometric series test", tags:"series convergence ratio common ar‚Åø"},
  {cat:"Convergence Tests", color:"#bf360c", sym:"divergence", name:"divergence test", tags:"series diverge nth term zero"},
  {cat:"Convergence Tests", color:"#bf360c", sym:"telescoping", name:"telescoping series", tags:"series collapse cancel partial fractions"},

  // === ANSWER WORDS ===
  {cat:"Answer Words", color:"#bf360c", sym:"converges", name:"converges", tags:"answer series limit finite"},
  {cat:"Answer Words", color:"#bf360c", sym:"diverges", name:"diverges", tags:"answer series limit infinite"},
  {cat:"Answer Words", color:"#bf360c", sym:"converges to", name:"converges to", tags:"answer series limit value"},
  {cat:"Answer Words", color:"#bf360c", sym:"diverges to ‚àû", name:"diverges to infinity", tags:"answer series infinite"},
  {cat:"Answer Words", color:"#bf360c", sym:"absolutely", name:"converges absolutely", tags:"answer series absolute value"},
  {cat:"Answer Words", color:"#bf360c", sym:"conditionally", name:"converges conditionally", tags:"answer series not absolute"},
  {cat:"Answer Words", color:"#bf360c", sym:"undefined", name:"undefined", tags:"answer no value"},
  {cat:"Answer Words", color:"#bf360c", sym:"DNE", name:"does not exist", tags:"answer no limit"},
  {cat:"Answer Words", color:"#bf360c", sym:"continuous", name:"continuous", tags:"answer function no break"},
  {cat:"Answer Words", color:"#bf360c", sym:"discontinuous", name:"discontinuous", tags:"answer function break gap jump"},
  {cat:"Answer Words", color:"#bf360c", sym:"increasing", name:"increasing", tags:"answer function positive derivative"},
  {cat:"Answer Words", color:"#bf360c", sym:"decreasing", name:"decreasing", tags:"answer function negative derivative"},
  {cat:"Answer Words", color:"#bf360c", sym:"maximum", name:"maximum", tags:"answer function max peak top"},
  {cat:"Answer Words", color:"#bf360c", sym:"minimum", name:"minimum", tags:"answer function min valley bottom"},

  // === QUICK PHRASES ===
  {cat:"Quick Phrases", color:"#004d40", sym:"from 0 to 1", name:"from 0 to 1", tags:"bounds limits integral"},
  {cat:"Quick Phrases", color:"#004d40", sym:"from 0 to ‚àû", name:"from 0 to infinity", tags:"bounds limits integral improper"},
  {cat:"Quick Phrases", color:"#004d40", sym:"from 0 to œÄ", name:"from 0 to pi", tags:"bounds limits integral trig"},
  {cat:"Quick Phrases", color:"#004d40", sym:"from 0 to 2œÄ", name:"from 0 to 2 pi", tags:"bounds limits integral full circle"},
  {cat:"Quick Phrases", color:"#004d40", sym:"from ‚àí‚àû to ‚àû", name:"from neg infinity to pos infinity", tags:"bounds limits integral both sides"},
  {cat:"Quick Phrases", color:"#004d40", sym:"from a to b", name:"from a to b", tags:"bounds limits integral general"},
  {cat:"Quick Phrases", color:"#004d40", sym:"from 1 to ‚àû", name:"from 1 to infinity", tags:"bounds limits integral improper"},
  {cat:"Quick Phrases", color:"#004d40", sym:"as n‚Üí‚àû", name:"as n approaches infinity", tags:"limit sequence series"},
  {cat:"Quick Phrases", color:"#004d40", sym:"as x‚Üí0", name:"as x approaches 0", tags:"limit function origin"},
  {cat:"Quick Phrases", color:"#004d40", sym:"as x‚Üí‚àû", name:"as x approaches infinity", tags:"limit function end behavior"},
  {cat:"Quick Phrases", color:"#004d40", sym:"as x‚Üía", name:"as x approaches a", tags:"limit function point"},
  {cat:"Quick Phrases", color:"#004d40", sym:"n=1 to ‚àû", name:"n equals 1 to infinity", tags:"summation bounds series index"},
  {cat:"Quick Phrases", color:"#004d40", sym:"+ C", name:"plus C", tags:"constant integration indefinite"},
  {cat:"Quick Phrases", color:"#004d40", sym:"= 0", name:"equals zero", tags:"answer result"},
  {cat:"Quick Phrases", color:"#004d40", sym:"= 1", name:"equals one", tags:"answer result"},
  {cat:"Quick Phrases", color:"#004d40", sym:"= ‚àû", name:"equals infinity", tags:"answer diverges"},
];

let pendingLibSym = null;

function toggleLibrary() {
  const overlay = document.getElementById('libraryOverlay');
  overlay.classList.toggle('active');
  if (overlay.classList.contains('active')) {
    document.getElementById('libSearch').value = '';
    renderLibrary(LIBRARY);
    setTimeout(() => document.getElementById('libSearch').focus(), 100);
  }
}

function filterLibrary() {
  const query = document.getElementById('libSearch').value.toLowerCase().trim();
  if (!query) {
    renderLibrary(LIBRARY);
    return;
  }
  const words = query.split(/\s+/);
  const filtered = LIBRARY.filter(item => {
    const searchable = (item.sym + ' ' + item.name + ' ' + item.tags + ' ' + item.cat).toLowerCase();
    return words.every(w => searchable.includes(w));
  });
  renderLibrary(filtered);
}

function renderLibrary(items) {
  const container = document.getElementById('libResults');
  if (items.length === 0) {
    container.innerHTML = '<div class="no-results">No symbols found. Try different search terms.</div>';
    return;
  }

  // Group by category
  const grouped = {};
  items.forEach(item => {
    if (!grouped[item.cat]) grouped[item.cat] = [];
    grouped[item.cat].push(item);
  });

  let html = '';
  for (const [catName, catItems] of Object.entries(grouped)) {
    const color = catItems[0].color;
    html += `<div class="lib-category-name" style="background:${color}">${catName}</div>`;
    html += '<div class="lib-grid">';
    catItems.forEach((item, idx) => {
      html += `
        <div class="lib-item" onclick="addFromLibrary('${escapeAttr(item.sym)}','${escapeAttr(item.name)}', event)">
          <div class="lib-sym">${escapeHtml(item.sym)}</div>
          <div class="lib-name">${escapeHtml(item.name)}</div>
          <div class="lib-tags">${escapeHtml(item.tags)}</div>
          <button class="lib-add-btn">+ Add to Board</button>
        </div>`;
    });
    html += '</div>';
  }
  container.innerHTML = html;
}

function escapeAttr(str) {
  return str.replace(/'/g, "\\'").replace(/"/g, '&quot;');
}

function addFromLibrary(sym, name, event) {
  pendingLibSym = { s: sym.replace(/\\'/g, "'"), n: name.replace(/\\'/g, "'") };

  const picker = document.getElementById('catPicker');
  picker.innerHTML = '<div style="padding:4px 8px;font-size:0.7rem;color:#888;font-weight:600;">ADD TO WHICH SECTION?</div>';

  boardData.forEach((cat, idx) => {
    const opt = document.createElement('div');
    opt.className = 'lib-cat-option';
    opt.textContent = cat.name;
    opt.style.borderLeft = `4px solid ${cat.color}`;
    opt.onclick = function() {
      boardData[idx].symbols.push({ s: pendingLibSym.s, n: pendingLibSym.n });
      picker.classList.remove('active');
      render();
      // Show confirmation
      const status = document.getElementById('exportStatus');
      status.textContent = `‚úÖ Added "${pendingLibSym.s}" (${pendingLibSym.n}) to ${cat.name}`;
      status.style.display = 'block';
      status.classList.add('active');
      setTimeout(() => { status.style.display = 'none'; status.classList.remove('active'); }, 3000);
    };
    picker.appendChild(opt);
  });

  // Position near click
  const rect = event.currentTarget.getBoundingClientRect();
  picker.style.left = Math.min(rect.left, window.innerWidth - 250) + 'px';
  picker.style.top = Math.min(rect.bottom + 4, window.innerHeight - 300) + 'px';
  picker.classList.add('active');
}

// Close picker when clicking elsewhere
document.addEventListener('click', function(e) {
  const picker = document.getElementById('catPicker');
  if (picker.classList.contains('active') && !picker.contains(e.target) && !e.target.closest('.lib-item')) {
    picker.classList.remove('active');
  }
});

// ========== MOVE SYMBOLS ==========
function moveSymbol(catIdx, symIdx, direction) {
  const newIdx = symIdx + direction;
  if (newIdx < 0 || newIdx >= boardData[catIdx].symbols.length) return;
  const symbols = boardData[catIdx].symbols;
  const temp = symbols[symIdx];
  symbols[symIdx] = symbols[newIdx];
  symbols[newIdx] = temp;
  render();
}

// ========== DRAG AND DROP ==========
let dragSrcCatIdx = null;
let dragSrcSymIdx = null;

function handleDragStart(e) {
  this.classList.add('dragging');
  dragSrcCatIdx = parseInt(this.dataset.catIdx);
  dragSrcSymIdx = parseInt(this.dataset.symIdx);
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
}

function handleDragEnter(e) {
  e.preventDefault();
  this.classList.add('drag-over');
}

function handleDragLeave(e) {
  this.classList.remove('drag-over');
}

function handleDrop(e) {
  e.stopPropagation();
  this.classList.remove('drag-over');

  const destCatIdx = parseInt(this.dataset.catIdx);
  const destSymIdx = parseInt(this.dataset.symIdx);

  if (dragSrcCatIdx === destCatIdx && dragSrcSymIdx === destSymIdx) return;

  // Remove from source
  const sym = boardData[dragSrcCatIdx].symbols.splice(dragSrcSymIdx, 1)[0];

  // Insert at destination
  boardData[destCatIdx].symbols.splice(destSymIdx, 0, sym);

  render();
}

function handleDragEnd(e) {
  document.querySelectorAll('.sym-card').forEach(c => {
    c.classList.remove('dragging', 'drag-over');
  });
}

// ========== SYMBOL OPERATIONS ==========
function editSymbol(catIdx, symIdx) {
  editingCatIdx = catIdx;
  editingSymIdx = symIdx;
  isAdding = false;
  const sym = boardData[catIdx].symbols[symIdx];
  document.getElementById('modalTitle').textContent = 'Edit Symbol';
  document.getElementById('symInput').value = sym.s;
  document.getElementById('nameInput').value = sym.n;
  document.getElementById('symbolModal').classList.add('active');
  document.getElementById('symInput').focus();
}

function addSymbol(catIdx) {
  editingCatIdx = catIdx;
  editingSymIdx = null;
  isAdding = true;
  document.getElementById('modalTitle').textContent = 'Add New Symbol';
  document.getElementById('symInput').value = '';
  document.getElementById('nameInput').value = '';
  document.getElementById('symbolModal').classList.add('active');
  document.getElementById('symInput').focus();
}

function saveSymbol() {
  const s = document.getElementById('symInput').value.trim();
  const n = document.getElementById('nameInput').value.trim();
  if (!s) { alert('Symbol cannot be empty'); return; }

  if (isAdding) {
    boardData[editingCatIdx].symbols.push({ s, n: n || s });
  } else {
    boardData[editingCatIdx].symbols[editingSymIdx] = { s, n: n || s };
  }

  closeModal();
  render();
}

function deleteSymbol(catIdx, symIdx) {
  const sym = boardData[catIdx].symbols[symIdx];
  if (confirm(`Delete "${sym.s}" (${sym.n})?`)) {
    boardData[catIdx].symbols.splice(symIdx, 1);
    render();
  }
}

function closeModal() {
  document.getElementById('symbolModal').classList.remove('active');
}

// ========== CATEGORY OPERATIONS ==========
function addCategory() {
  document.getElementById('catModalTitle').textContent = 'Add New Section';
  document.getElementById('catNameInput').value = '';
  document.getElementById('catColorInput').value = '#6366f1';
  editingCatIdx = null;
  document.getElementById('catModal').classList.add('active');
  document.getElementById('catNameInput').focus();
}

function editCategoryName(catIdx) {
  document.getElementById('catModalTitle').textContent = 'Edit Section';
  document.getElementById('catNameInput').value = boardData[catIdx].name;
  document.getElementById('catColorInput').value = boardData[catIdx].color;
  editingCatIdx = catIdx;
  document.getElementById('catModal').classList.add('active');
  document.getElementById('catNameInput').focus();
}

function saveCategory() {
  const name = document.getElementById('catNameInput').value.trim();
  const color = document.getElementById('catColorInput').value;
  if (!name) { alert('Name cannot be empty'); return; }

  if (editingCatIdx !== null && editingCatIdx < boardData.length) {
    boardData[editingCatIdx].name = name;
    boardData[editingCatIdx].color = color;
  } else {
    boardData.push({
      id: name.toLowerCase().replace(/[^a-z0-9]/g, '_'),
      name: name,
      color: color,
      symbols: []
    });
  }

  closeCatModal();
  render();
}

function deleteCategory(catIdx) {
  if (confirm(`Delete entire section "${boardData[catIdx].name}" and all its symbols?`)) {
    boardData.splice(catIdx, 1);
    render();
  }
}

function moveCategoryUp(catIdx) {
  if (catIdx <= 0) return;
  const temp = boardData[catIdx];
  boardData[catIdx] = boardData[catIdx - 1];
  boardData[catIdx - 1] = temp;
  render();
}

function moveCategoryDown(catIdx) {
  if (catIdx >= boardData.length - 1) return;
  const temp = boardData[catIdx];
  boardData[catIdx] = boardData[catIdx + 1];
  boardData[catIdx + 1] = temp;
  render();
}

function closeCatModal() {
  document.getElementById('catModal').classList.remove('active');
  editingCatIdx = null;
}

// ========== IMAGE EXPORT ==========
function exportImages() {
  const statusEl = document.getElementById('exportStatus');
  statusEl.textContent = '‚è≥ Generating images... this may take a minute';
  statusEl.style.display = 'block';
  statusEl.classList.add('active');

  const zip = new JSZip();
  const canvas = document.createElement('canvas');
  canvas.width = 400;
  canvas.height = 400;
  const ctx = canvas.getContext('2d');

  const catColors = {};
  boardData.forEach(cat => { catColors[cat.id] = cat.color; });

  let totalImages = 0;

  boardData.forEach((cat, catIdx) => {
    const safeCatName = cat.name.replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '_');
    const folder = zip.folder(safeCatName);

    cat.symbols.forEach((sym, symIdx) => {
      // Draw card image
      ctx.clearRect(0, 0, 400, 400);

      // White background
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, 400, 400);

      // Border
      ctx.strokeStyle = '#c8c8c8';
      ctx.lineWidth = 2;
      ctx.strokeRect(1, 1, 398, 398);

      // Color accent bar at top
      ctx.fillStyle = cat.color;
      ctx.fillRect(0, 0, 400, 8);

      // Symbol text
      let fontSize = 140;
      if (sym.s.length > 10) fontSize = 44;
      else if (sym.s.length > 7) fontSize = 56;
      else if (sym.s.length > 4) fontSize = 72;
      else if (sym.s.length > 2) fontSize = 100;

      ctx.fillStyle = '#1e1e1e';
      ctx.font = `bold ${fontSize}px "Segoe UI", "DejaVu Sans", Arial, sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(sym.s, 200, 170);

      // Separator line
      ctx.strokeStyle = '#dcdcdc';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(40, 300);
      ctx.lineTo(360, 300);
      ctx.stroke();

      // Name text
      let nameFontSize = 26;
      if (sym.n.length > 20) nameFontSize = 20;
      else if (sym.n.length > 14) nameFontSize = 22;

      ctx.fillStyle = '#555555';
      ctx.font = `${nameFontSize}px "Segoe UI", "DejaVu Sans", Arial, sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(sym.n, 200, 345);

      // Category color dot
      ctx.fillStyle = cat.color;
      ctx.beginPath();
      const dotX = 200 - ctx.measureText(sym.n).width / 2 - 16;
      ctx.arc(dotX, 345, 5, 0, Math.PI * 2);
      ctx.fill();

      // Convert to PNG and add to zip
      const safeName = sym.n.replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '_');
      const fileName = `${String(symIdx + 1).padStart(2, '0')}_${safeName}.png`;
      const dataUrl = canvas.toDataURL('image/png');
      const base64 = dataUrl.split(',')[1];
      folder.file(fileName, base64, { base64: true });

      totalImages++;
    });
  });

  // Also create ALL_FLAT folder
  const flatFolder = zip.folder('ALL_FLAT');
  boardData.forEach((cat) => {
    const safeCatName = cat.name.replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '_');
    cat.symbols.forEach((sym, symIdx) => {
      const safeName = sym.n.replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '_');
      const shortCat = safeCatName.substring(0, 20);

      // Redraw for flat folder
      ctx.clearRect(0, 0, 400, 400);
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, 400, 400);
      ctx.strokeStyle = '#c8c8c8';
      ctx.lineWidth = 2;
      ctx.strokeRect(1, 1, 398, 398);
      ctx.fillStyle = cat.color;
      ctx.fillRect(0, 0, 400, 8);

      let fontSize = 140;
      if (sym.s.length > 10) fontSize = 44;
      else if (sym.s.length > 7) fontSize = 56;
      else if (sym.s.length > 4) fontSize = 72;
      else if (sym.s.length > 2) fontSize = 100;

      ctx.fillStyle = '#1e1e1e';
      ctx.font = `bold ${fontSize}px "Segoe UI", "DejaVu Sans", Arial, sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(sym.s, 200, 170);

      ctx.strokeStyle = '#dcdcdc';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(40, 300);
      ctx.lineTo(360, 300);
      ctx.stroke();

      let nameFontSize = 26;
      if (sym.n.length > 20) nameFontSize = 20;
      else if (sym.n.length > 14) nameFontSize = 22;

      ctx.fillStyle = '#555555';
      ctx.font = `${nameFontSize}px "Segoe UI", "DejaVu Sans", Arial, sans-serif`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(sym.n, 200, 345);

      ctx.fillStyle = cat.color;
      ctx.beginPath();
      const dotX = 200 - ctx.measureText(sym.n).width / 2 - 16;
      ctx.arc(dotX, 345, 5, 0, Math.PI * 2);
      ctx.fill();

      const fileName = `${shortCat}_${String(symIdx + 1).padStart(2, '0')}_${safeName}.png`;
      const dataUrl = canvas.toDataURL('image/png');
      const base64 = dataUrl.split(',')[1];
      flatFolder.file(fileName, base64, { base64: true });
    });
  });

  // Generate zip
  zip.generateAsync({ type: 'blob' }).then(function(content) {
    saveAs(content, 'Calc2_AAC_Symbol_Images.zip');
    statusEl.textContent = `‚úÖ ${totalImages} images exported in zip! Organized by category + ALL_FLAT folder.`;
    setTimeout(() => { statusEl.style.display = 'none'; statusEl.classList.remove('active'); }, 5000);
  }).catch(function(err) {
    statusEl.textContent = '‚ùå Image export failed: ' + err.message;
  });
}

// ========== PDF EXPORT ==========
function exportPDF() {
  // Hide all edit UI
  const actions = document.querySelectorAll('.card-actions, .add-card, .cat-header-actions');
  actions.forEach(el => el.style.display = 'none');

  const topbar = document.querySelector('.topbar');
  const instructions = document.querySelector('.instructions');
  const exportStatus = document.getElementById('exportStatus');
  topbar.style.display = 'none';
  instructions.style.display = 'none';
  exportStatus.style.display = 'none';

  const board = document.getElementById('board');

  const opt = {
    margin: [10, 10, 10, 10],
    filename: 'Calc2_AAC_Communication_Board.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' },
    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
  };

  // Show generating status
  const statusEl = document.getElementById('exportStatus');
  statusEl.textContent = '‚è≥ Generating PDF... please wait';
  statusEl.style.display = 'block';

  html2pdf().set(opt).from(board).save().then(() => {
    // Restore UI
    topbar.style.display = '';
    instructions.style.display = '';
    actions.forEach(el => el.style.display = '');
    statusEl.textContent = '‚úÖ PDF exported successfully!';
    statusEl.style.display = 'block';
    setTimeout(() => statusEl.style.display = 'none', 4000);
  }).catch(err => {
    topbar.style.display = '';
    instructions.style.display = '';
    actions.forEach(el => el.style.display = '');
    statusEl.textContent = '‚ùå PDF export failed: ' + err.message;
    statusEl.style.display = 'block';
  });
}

// ========== EXPORT / IMPORT ==========
function exportJSON() {
  const exportData = { title: boardTitle, categories: boardData };
  const json = JSON.stringify(exportData, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'calc2_aac_board.json';
  a.click();
  URL.revokeObjectURL(url);

  const status = document.getElementById('exportStatus');
  status.textContent = '‚úÖ Board saved! You can reload this file anytime with the Import button.';
  status.classList.add('active');
  setTimeout(() => status.classList.remove('active'), 4000);
}

function importJSON(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (Array.isArray(data)) {
        boardData = data;
        render();
      } else if (data.categories && Array.isArray(data.categories)) {
        boardData = data.categories;
        if (data.title) {
          boardTitle = data.title;
          saveTitle();
        }
        render();
      } else {
        alert('Invalid file format');
        return;
      }
      const status = document.getElementById('exportStatus');
        status.textContent = '‚úÖ Board imported successfully!';
      status.classList.add('active');
      setTimeout(() => status.classList.remove('active'), 4000);
    } catch (err) {
      alert('Error reading file: ' + err.message);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// ========== KEYBOARD SHORTCUTS ==========
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeModal();
    closeCatModal();
  }
  if (e.key === 'Enter') {
    if (document.getElementById('symbolModal').classList.contains('active')) {
      saveSymbol();
    }
    if (document.getElementById('catModal').classList.contains('active')) {
      saveCategory();
    }
  }
});

// ========== INIT ==========
render();
</script>
</body>
</html>
